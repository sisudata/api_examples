--SNOWFLAKE CREATE SCRIPT
--SCHEMA V2
CREATE DATABASE IF NOT EXISTS SISU_OUTPUTS;

CREATE OR REPLACE TABLE ANALYSIS_RESULT_WATERFALL (
    ANALYSIS_ID BIGINT PRIMARY KEY,
    ANALYSIS_RESULT_ID BIGINT PRIMARY KEY,
    STEP_ID INTEGER PRIMARY KEY,
    STEP_TYPE TEXT,
    FACTOR_0_DIMENSION TEXT,
    FACTOR_0_VALUE TEXT,
    FACTOR_1_DIMENSION TEXT,
    FACTOR_1_VALUE TEXT,
    FACTOR_2_DIMENSION TEXT,
    FACTOR_2_VALUE TEXT,
    STEP_IMPACT FLOAT,
    CUMULATIVE_IMPACT_BEFORE_STEP FLOAT,
    CUMULATIVE_IMPACT_AFTER_STEP FLOAT,
    OVERLAPPING_IMPACT FLOAT,
    CHANGE_IN_SIZE_SET1 FLOAT,
    CHANGE_IN_SIZE_SET2 FLOAT,
    CHANGE_IN_TYPE_SET1 FLOAT,
    CHANGE_IN_TYPE_SET2 FLOAT,
    CONSTRAINT PK PRIMARY KEY (ANALYSIS_ID, ANALYSIS_RESULT_ID, STEP_ID)
);

--TABLE TO HOLD TREND RESULT DETAILS
CREATE OR REPLACE TABLE TREND_RESULT_DETAIL (
    ANALYSIS_ID BIGINT,
    ANALYSIS_RESULT_ID BIGINT,
    SUBGROUP_ID BIGINT,
    FACTOR_0_DIMENSION TEXT,
    FACTOR_0_VALUE TEXT,
    FACTOR_1_DIMENSION TEXT,
    FACTOR_1_VALUE TEXT,
    FACTOR_2_DIMENSION TEXT,
    FACTOR_2_VALUE TEXT,
    IMPACT FLOAT,
    START_DATE TIMESTAMP,
    END_DATE TIMESTAMP,
    INTERCEPT FLOAT,
    SLOPE FLOAT,
    SIZE FLOAT,
    LOAD_TS TIMESTAMP,
    CONSTRAINT PK PRIMARY KEY (ANALYSIS_ID, ANALYSIS_RESULT_ID, SUBGROUP_ID)
);

--TABLE TO HOLD ANALYSIS RESULT DETAILS
CREATE OR REPLACE TABLE ANALYSIS_RESULT_DETAIL (
    ANALYSIS_ID BIGINT,
    ANALYSIS_RESULT_ID BIGINT,
    SUBGROUP_ID BIGINT,
    CONFIDENCE TEXT,
    FACTOR_0_DIMENSION TEXT,
    FACTOR_0_VALUE TEXT,
    FACTOR_1_DIMENSION TEXT,
    FACTOR_1_VALUE TEXT,
    FACTOR_2_DIMENSION TEXT,
    FACTOR_2_VALUE TEXT,
    FACTOR_0_DIMENSION_FRIENDLY TEXT,
    FACTOR_1_DIMENSION_FRIENDLY TEXT,
    FACTOR_2_DIMENSION_FRIENDLY TEXT,
    FACTOR_0_VALUE_FRIENDLY TEXT,
    FACTOR_1_VALUE_FRIENDLY TEXT,
    FACTOR_2_VALUE_FRIENDLY TEXT,
    FACTOR_0_TEXT TEXT,
    FACTOR_1_TEXT TEXT,
    FACTOR_2_TEXT TEXT,
    SEGMENT_TEXT TEXT,
    IMPACT FLOAT,
    IMPACT_MAGNITUDE FLOAT,
    IMPACT_RANK TEXT,
    SET1_SIZE FLOAT,
    SET2_SIZE FLOAT,
    SET1_VALUE FLOAT,
    SET2_VALUE FLOAT,
    PERCENT_CHANGE FLOAT,
    DIRECTION TEXT,
    DIRECTION_TEXT TEXT,
    ORIENTATION_MATCHES_METRIC TEXT,
    SEGMENT_ORDER SMALLINT,
    SEGMENT_ORDER_TEXT TEXT,
    INSIGHT_TEXT TEXT,
    CHANGE_IN_SIZE FLOAT,
    MIX_EFFECT FLOAT,
    NET_EFFECT FLOAT,
    NET_RELATIVE_EFFECT FLOAT,
    PERCENT_CHANGE_IN_SIZE FLOAT,
    RATE_EFFECT FLOAT,
    RELATIVE_PERCENT_CHANGE FLOAT,
    RATE_CHANGE FLOAT,
    RELATIVE_MIX_EFFECT FLOAT,
    SEGMENT_NAME TEXT,
    SEGMENT_RANK TEXT,
    SEGMENT_HASH TEXT,
    UNWEIGHTED_CHANGE_IN_AVERAGE FLOAT,
    WEIGHT FLOAT,
    WEIGHTED_CHANGE_IN_SUM FLOAT,
    UNITS TEXT,
    LOAD_TS TIMESTAMP,
    CONSTRAINT PK PRIMARY KEY (ANALYSIS_ID, ANALYSIS_RESULT_ID, SUBGROUP_ID)
);

--TABLE TO HOLD TREND RESULT SUMMARY INFORMATION
CREATE OR REPLACE TABLE TREND_RESULT_SUMMARY (
    ANALYSIS_ID BIGINT,
    ANALYSIS_RESULT_ID BIGINT,
    REQUESTED_AT TIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    RUN_STATUS TEXT,
    RUN_TYPE TEXT,
    CURRENT_PERIOD_CARD_LABEL TEXT,
    CURRENT_PERIOD_DENOMINATOR_LABEL TEXT,
    CURRENT_PERIOD_PERCENT_CHANGE FLOAT,
    CURRENT_PERIOD_SLOPE FLOAT,
    PREVIOUS_PERIOD_CARD_LABEL TEXT,
    PREVIOUS_PERIOD_DENOMINATOR_LABEL TEXT,
    PREVIOUS_PERIOD_PERCENT_CHANGE FLOAT,
    PREVIOUS_PERIOD_SLOPE FLOAT,
    LOAD_TS TIMESTAMP,
    CONSTRAINT PK PRIMARY KEY (ANALYSIS_ID, ANALYSIS_RESULT_ID)
);

--TABLE TO HOLD ANALYSIS RESULT SUMMARY INFORMATION
CREATE OR REPLACE TABLE ANALYSIS_RESULT_SUMMARY (
    ANALYSIS_ID BIGINT,
    ANALYSIS_RESULT_ID BIGINT,
    REQUESTED_AT TIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    RUN_STATUS TEXT,
    RUN_TYPE TEXT,
    TIMEFRAME TEXT,
    PREVIOUS_PERIOD_START TIMESTAMP,
    PREVIOUS_PERIOD_END TIMESTAMP,
    RECENT_PERIOD_START TIMESTAMP,
    RECENT_PERIOD_END TIMESTAMP,
    GROUP_A_NAME TEXT,
    GROUP_B_NAME TEXT,
    METRIC_TYPE_LABEL TEXT,
    PERCENT_CHANGE FLOAT,
    DIRECTION TEXT,
    SET1_CARD_LABEL TEXT,
    SET1_CATEGORY_FILTER TEXT,
    SET1_AVERAGE FLOAT,
    SET1_MIN FLOAT,
    SET1_MAX FLOAT,
    SET1_MEDIAN FLOAT,
    SET1_SUM FLOAT,
    SET1_SUMMARY_VALUE FLOAT,
    SET1_TOTAL_SIZE FLOAT,
    SET1_TOTAL_NUMERATOR FLOAT,
    SET1_TOTAL_DENOMINATOR FLOAT,
    SET1_MATCH_SIZE FLOAT,
    SET1_WEIGHT FLOAT,
    SET2_CARD_LABEL TEXT,
    SET2_CATEGORY_FILTER TEXT,
    SET2_AVERAGE FLOAT,
    SET2_MIN FLOAT,
    SET2_MAX FLOAT,
    SET2_MEDIAN FLOAT,
    SET2_SUM FLOAT,
    SET2_SUMMARY_VALUE FLOAT,
    SET2_TOTAL_SIZE FLOAT,
    SET2_TOTAL_NUMERATOR FLOAT,
    SET2_TOTAL_DENOMINATOR FLOAT,
    SET2_MATCH_SIZE FLOAT,
    SET2_WEIGHT FLOAT,
    LOAD_TS TIMESTAMP,
    CONSTRAINT PK PRIMARY KEY (ANALYSIS_ID, ANALYSIS_RESULT_ID)
);

--TABLE TO HOLD ANALYSIS INFORMATION
CREATE OR REPLACE TABLE ANALYSIS (
    ANALYSIS_ID BIGINT PRIMARY KEY,
    ANALYSIS_NAME TEXT,
    ANALYSIS_TYPE TEXT,
    APPLICATION_URL TEXT,
    CREATED_AT TIMESTAMP,
    METRIC_ID BIGINT,
    METRIC_NAME TEXT,
    METRIC_DESIRED_DIRECTION TEXT,
    PROJECT_ID BIGINT,
    PROJECT_NAME TEXT,
    LOAD_TS TIMESTAMP
);

